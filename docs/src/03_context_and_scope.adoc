ifndef::imagesdir[:imagesdir: ../images]

[[section-context-and-scope]]
== Context and Scope

Yovi is a distributed web application that allows users and bots to play the Y board game. The system provides a platform where human players can compete against each other or against AI bots, with match history and statistics tracking for registered users.

=== Business Context

==== Communication Partners

[plantuml, business-context, png]
----
@startuml
!define RECTANGLE rectangle

skinparam rectangle {
  BackgroundColor<<system>> LightBlue
  BorderColor<<system>> Blue
}

actor "Human Player\n(Web User)" as user
actor "Bot Client\n(External/Internal)" as bot
actor "Administrator" as admin

RECTANGLE "Yovi System" as system <<system>>

user --> system : Registration/Login\nGame moves (YEN)\nMatch creation\nStatistics queries

system --> user : Auth tokens/sessions\nGame state (YEN)\nMove validation\nMatch results\nStatistics

bot --> system : Bot authentication\nGame moves (YEN)\nMatch participation

system --> bot : Auth tokens\nGame state (YEN)\nMove validation\nMatch outcomes

admin --> system : System monitoring\nUser management\nBot configuration

system --> admin : System status\nUser data\nBot metrics

note right of system
  **Key Domain Concepts:**
  - YEN (Y-encoded Notation)
  - Match sessions
  - Strategy/difficulty levels
  - Anonymous play support
end note

@enduml
----

[cols="1,2,2", options="header"]
|===
| Partner | Input | Output

| **Human Player (Web User)**
a| • User registration/login credentials
• Game moves (position=YEN, strategy, difficulty)
• Match creation requests (size, strategy, difficulty)
• Statistics/history queries
a| • Authentication tokens/sessions
• Current game state (YEN format)
• Valid/invalid move responses
• Match results and statistics
• Game history data

| **Bot Client (External/Internal)**
a| • Bot authentication
• Game moves via Bot API (position=YEN, strategy, difficulty)
• Match participation requests
a| • Authentication tokens
• Current game state (YEN format)
• Move validation responses
• Match outcomes

| **Administrator**
a| • System monitoring requests
• User management operations
• Bot registration/configuration
a| • System status
• User data
• Bot performance metrics
|===

==== Domain Concepts

* **YEN (Y-encoded Notation)**: Domain-specific format for representing board positions and moves in the Y game
* **Match**: A game session between two players (human or bot)
* **Strategy**: Game difficulty level and bot behavior configuration
* **Anonymous Play**: Unregistered users can play but their scores are not persisted

=== Technical Context

==== System Architecture

[plantuml, technical-context-deployment, png]
----
@startuml
!include <C4/C4_Deployment>

node "Client Browser" as browser {
  artifact "React App\n(Webapp)\nbundled JS" as react
}

node "API Gateway" as nginxnode {
  artifact "Nginx\nReverse Proxy" as nginx
}

node "Users Service Server" as usersserver {
  artifact "Node.js\nUsers Service\n(Express + TS)" as users
  database "SQLite DB\n(users.db)" as sqlitedb
}

node "Game Engine Server" as gameserver {
  artifact "Rust Binary\n(Game Server)" as rust
}

browser -down-> nginx : HTTP (80)\nREST API\nJSON
nginx -down-> react : Static files
nginx -down-> users : HTTP (3000)\n/api/users/*
nginx -down-> rust : HTTP (4000)\n/api/gamey/*
users -down-> sqlitedb : SQLite protocol\nSQL queries\n(embedded)

note right of browser
  **Client Environment**
  Modern web browser
  JavaScript runtime
  React SPA
end note

note right of nginxnode
  **Entry Point**
  Reverse proxy
  Rate limiting, CORS
  Routes: /api/users, /api/gamey, /
end note

note right of usersserver
  **Data Layer**
  Single DB access point
  Auth, users, matches, stats
end note

note right of gameserver
  **Game Logic Service**
  Stateless computation
  Fast move validation
end note

@enduml
----

==== Technical Interfaces

[cols="2,2,1,3", options="header"]
|===
| Component Connection | Protocol/Technology | Port/Channel | Purpose

| **Web Browser → Nginx (API Gateway)**
| HTTP, REST API
| 80 (HTTP)
a| • Single public entry point
• Request routing to backend services
• CORS handling
• Rate limiting
• Static file serving (React frontend)

| **Nginx → Users Service**
| HTTP, REST API
| 3000 (HTTP)
a| • User authentication and registration
• Match persistence
• Statistics retrieval
• Database access abstraction

| **Nginx → Game Server**
| HTTP, REST API
| 4000 (HTTP)
a| • Bot move computation
• Move validation
• Win condition checking
• YEN format game logic

| **Users Service → Database**
| SQLite native (embedded)
| Local file access
a| • User CRUD operations
• Match state persistence
• Statistics aggregation
• Transaction management

| **React Frontend (in Browser) → Nginx**
| HTTP, REST API, AJAX
| 80 (HTTP)
a| • API calls to backend services
• Game state updates
• User authentication
• Statistics queries
|===

==== Key API Endpoints

**Authentication & User Management (via Nginx → Users Service):**

* `POST /api/users/auth/register` - User registration
* `POST /api/users/auth/login` - User authentication
* `GET /api/users/matches` - Retrieve user matches (requires authentication)
* `POST /api/users/matches` - Create new match (size, strategy, difficulty)
* `GET /api/users/stats` - Retrieve player statistics and match history

**Game Logic (via Nginx → Game Server):**

* `POST /api/gamey/play` - Submit player move (position=YEN, strategy, difficulty)
** Returns: Updated YEN board state, move validation status
* `POST /api/gamey/ybot/choose/{botId}` - Bot move computation
** Returns: YenMoveDto + game status
* `GET /api/gamey/validate` - Validate move without executing

**Bot API (External bots via Nginx):**

* `POST /api/gamey/bot/play` - Bot move submission (position=YEN, strategy, difficulty)

==== Data Formats

**YEN Notation Example:**
[source,json]
----
{
  "size": 4,
  "turn": "R",
  "players": ["B", "R"],
  "layout": "B/.B/RB./B..R"
}
----

**Move Request/Response:**
[source,json]
----
{
  "position": "B/.B/RB./B..R",
  "strategy": "heuristic",
  "difficulty": 3,
  "nextMove": {
    "player": "R",
    "coordinate": {"x": 0, "y": 1, "z": 2}
  }
}
----

==== Deployment Considerations

* **Containerization**: All services (React Frontend, Nginx, Users Service, Game Server) are containerized using Docker for consistent deployment
* **Database**: SQLite file stored as volume mount in Users Service for data persistence
* **Scalability**: Game Server is stateless and can be horizontally scaled behind Nginx load balancer
* **Security**: Nginx handles CORS, rate limiting, and request validation
* **API Gateway**: Nginx isolates backend services from direct external access
* **Frontend Deployment**: React app is built and served as static files through Nginx
