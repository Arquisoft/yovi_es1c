ifndef::imagesdir[:imagesdir: ../images]

[[section-context-and-scope]]
== Context and Scope

Yovi is a distributed web application that allows users and bots to play the Y board game. The system provides a platform where human players can compete against each other or against AI bots, with match history and statistics tracking for registered users.

=== Business Context

==== Communication Partners

[plantuml, business-context, png]
----
@startuml
!define RECTANGLE rectangle

skinparam rectangle {
  BackgroundColor<<system>> LightBlue
  BorderColor<<system>> Blue
}

actor "Human Player\n(Web User)" as user
actor "Bot Client\n(External/Internal)" as bot
actor "Administrator" as admin

RECTANGLE "Yovi System" as system <<system>>

user --> system : Registration/Login\nGame moves (YEN)\nMatch creation\nStatistics queries

system --> user : Auth tokens/sessions\nGame state (YEN)\nMove validation\nMatch results\nStatistics

bot --> system : Bot authentication\nGame moves (YEN)\nMatch participation

system --> bot : Auth tokens\nGame state (YEN)\nMove validation\nMatch outcomes

admin --> system : System monitoring\nUser management\nBot configuration

system --> admin : System status\nUser data\nBot metrics

note right of system
  **Key Domain Concepts:**
  - YEN (Y-encoded Notation)
  - Match sessions
  - Strategy/difficulty levels
  - Anonymous play support
end note

@enduml
----

[cols="1,2,2", options="header"]
|===
| Partner | Input | Output

| **Human Player (Web User)**
a| • User registration/login credentials
• Game moves (position=YEN, strategy, difficulty)
• Match creation requests (size, strategy, difficulty)
• Statistics/history queries
a| • Authentication tokens/sessions
• Current game state (YEN format)
• Valid/invalid move responses
• Match results and statistics
• Game history data

| **Bot Client (External/Internal)**
a| • Bot authentication
• Game moves via Bot API (position=YEN, strategy, difficulty)
• Match participation requests
a| • Authentication tokens
• Current game state (YEN format)
• Move validation responses
• Match outcomes

| **Administrator**
a| • System monitoring requests
• User management operations
• Bot registration/configuration
a| • System status
• User data
• Bot performance metrics
|===

==== Domain Concepts

* **YEN (Y-encoded Notation)**: Domain-specific format for representing board positions and moves in the Y game
* **Match**: A game session between two players (human or bot)
* **Strategy**: Game difficulty level and bot behavior configuration
* **Anonymous Play**: Unregistered users can play but their scores are not persisted

=== Technical Context

==== System Architecture

[plantuml, technical-context-deployment, png]
----
@startuml
!include <C4/C4_Deployment>

node "Client Browser" as browser {
  artifact "React App\n(Webapp)\nbundled JS" as react
}

node "API Gateway" as nginxnode {
  artifact "Nginx\nReverse Proxy" as nginx
}

node "Auth Service Server" as authserver {
  artifact "Node.js\nAuth Service\n(Express + TS)" as auth
  database "SQLite DB\n(auth.db)" as authdb
}

node "Users Service Server" as usersserver {
  artifact "Node.js\nUsers Service\n(Express + TS)" as users
  database "SQLite DB\n(users.db)" as usersdb
}

node "Game Service Server" as gameserviceserver {
  artifact "Node.js\nGame Service\n(Express + TS)" as gameservice
  database "SQLite DB\n(game.db)" as gamedb
}

node "Game Engine Server" as gameserver {
  artifact "Rust Binary\n(Game Server)" as rust
}

browser -down-> nginx : HTTP (80)\nREST API\nJSON
nginx -down-> react : Static files
nginx -down-> auth : HTTP (3001)\n/api/auth/*
nginx -down-> users : HTTP (3000)\n/api/users/*
nginx -down-> gameservice : HTTP (3002)\n/api/game/*
nginx -down-> rust : HTTP (4000)\n/api/gamey/*
auth -down-> authdb : SQLite protocol\nSQL queries\n(embedded)
users -down-> usersdb : SQLite protocol\nSQL queries\n(embedded)
gameservice -down-> gamedb : SQLite protocol\nSQL queries\n(embedded)

note right of browser
  **Client Environment**
  Modern web browser
  JavaScript runtime
  React SPA
end note

note right of nginxnode
  **Entry Point**
  Reverse proxy
  Rate limiting, CORS
  Routes: /api/auth, /api/users,
  /api/game, /api/gamey, /
end note

note right of authserver
  **Auth Layer**
  Credentials & JWT
  auth.db
end note

note right of usersserver
  **Profile Layer**
  User profile data
  users.db
end note

note right of gameserviceserver
  **Game Data Layer**
  Matches, moves, stats
  game.db
end note

note right of gameserver
  **Game Logic Service**
  Stateless computation
  Fast move validation
end note

@enduml
----

==== Technical Interfaces

[cols="2,2,1,3", options="header"]
|===
| Component Connection | Protocol/Technology | Port/Channel | Purpose

| **Web Browser → Nginx (API Gateway)**
| HTTP, REST API
| 80 (HTTP)
a| • Single public entry point
• Request routing to backend services
• CORS handling
• Rate limiting
• Static file serving (React frontend)

| **Nginx → Auth Service**
| HTTP, REST API
| 3001 (HTTP)
a| • User authentication and registration
• JWT token generation and validation
• Credential management
• Password hashing

| **Nginx → Users Service**
| HTTP, REST API
| 3000 (HTTP)
a| • User profile retrieval and updates
• User search operations

| **Nginx → Game Service**
| HTTP, REST API
| 3002 (HTTP)
a| • Match creation and persistence
• Move history storage
• Statistics retrieval

| **Nginx → Game Server**
| HTTP, REST API
| 4000 (HTTP)
a| • Bot move computation
• Move validation
• Win condition checking
• YEN format game logic

| **Auth Service → auth.db**
| SQLite native (embedded)
| Local file access
a| • Credential CRUD operations
• JWT token metadata persistence
• Transaction management

| **Users Service → users.db**
| SQLite native (embedded)
| Local file access
a| • User profile CRUD operations
• Transaction management

| **Game Service → game.db**
| SQLite native (embedded)
| Local file access
a| • Match state persistence
• Move history storage
• Statistics aggregation

| **React Frontend (in Browser) → Nginx**
| HTTP, REST API, AJAX
| 80 (HTTP)
a| • API calls to all backend services
• Game state updates
• User authentication
• Statistics queries
|===

==== Key API Endpoints

**Authentication (via Nginx → Auth Service):**

* `POST /api/auth/register` - User registration
* `POST /api/auth/login` - User authentication, returns JWT token
* `POST /api/auth/refresh` - JWT token refresh

**User Profile Management (via Nginx → Users Service):**

* `GET /api/users/{id}` - Retrieve user profile
* `PUT /api/users/{id}` - Update user profile
* `GET /api/users` - Search users

**Game Data Management (via Nginx → Game Service):**

* `POST /api/game/matches` - Create new match (size, strategy, difficulty)
* `GET /api/game/matches/{id}` - Retrieve match state
* `POST /api/game/matches/{id}/moves` - Persist a move and updated YEN state
* `GET /api/game/stats/{userId}` - Retrieve player statistics and match history

**Game Logic (via Nginx → Game Server):**

* `POST /api/gamey/play` - Submit player move (position=YEN, strategy, difficulty)
** Returns: Updated YEN board state, move validation status
* `POST /api/gamey/ybot/choose/{botId}` - Bot move computation
** Returns: YenMoveDto + game status
* `GET /api/gamey/validate` - Validate move without executing

**Bot API (External bots via Nginx):**

* `POST /api/gamey/bot/play` - Bot move submission (position=YEN, strategy, difficulty)

==== Data Formats

**YEN Notation Example:**
[source,json]
----
{
  "size": 4,
  "turn": "R",
  "players": ["B", "R"],
  "layout": "B/.B/RB./B..R"
}
----

**Move Request/Response:**
[source,json]
----
{
  "position": "B/.B/RB./B..R",
  "strategy": "heuristic",
  "difficulty": 3,
  "nextMove": {
    "player": "R",
    "coordinate": {"x": 0, "y": 1, "z": 2}
  }
}
----

==== Deployment Considerations

* **Containerization**: All services (React Frontend, Nginx, Auth Service, Users Service, Game Service, Game Server) are containerized using Docker for consistent deployment
* **Databases**: Three independent SQLite files (`auth.db`, `users.db`, `game.db`), each stored as a separate volume mount in its respective service container
* **Fault Isolation**: A failure or overload in one database does not affect the others; authentication, profile, and game data are independently available
* **Scalability**: Game Server is stateless and can be horizontally scaled behind Nginx load balancer; each Node.js service can also be scaled independently
* **Security**: Nginx handles CORS, rate limiting, and request validation; no backend service is directly accessible from outside
* **API Gateway**: Nginx isolates all backend services from direct external access
* **Frontend Deployment**: React app is built and served as static files through Nginx
